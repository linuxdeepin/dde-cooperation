name: Windows MSVC Release
on:
  push:
    tags:
      - "*"

jobs:
  build_and_release:
    strategy:
      matrix:
        include:
          # 64-bit build
          - name: win64_msvc
            os: windows-2022
            build_type: Release
            msvc_arch: x64
            qt_arch: win64_msvc2019_64
            qt_version: 5.15.2
            qt_target: desktop
          # 32-bit build
          - name: win32_msvc
            os: windows-2022
            build_type: Release
            msvc_arch: x86
            qt_arch: win32_msvc2019_64
            qt_version: 5.15.2
            qt_target: desktop
    runs-on: ${{ matrix.os }}
    env:
      BUILD_TYPE: ${{ matrix.build_type }}
      QT_VERSION: ${{ matrix.qt_version }}
      COO_PROJECT: dde-cooperation
      DT_PROJECT: data-transfer
      # OpenSSL paths based on architecture
      OPENSSL_ROOT_DIR: ${{ matrix.msvc_arch == 'x64' && 'C:\Program Files\OpenSSL' || 'C:\Program Files (x86)\OpenSSL' }}
    steps:
      - name: "⚙️ Cache Qt"
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: ..\Qt
          key: Windows-QtCache-${{ env.QT_VERSION }}-${{ matrix.qt_arch }}

      - name: Install Qt ${{ env.QT_VERSION }} ${{ matrix.qt_arch }}
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: "==3.1.*"
          version: ${{ env.QT_VERSION }}
          target: ${{ matrix.qt_target }}
          arch: ${{ matrix.qt_arch }}
          cached: ${{ steps.cache-qt.outputs.cache-hit }}

      - name: Setup cmake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.31.5
          ninjaVersion: 1.11.1

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0

      - name: msvc-build
        shell: cmd
        env:
          vc_arch: ${{ matrix.msvc_arch }}
          cmake_gen: Visual Studio 17 2022
          APP_VERSION: ${{ github.ref_name }}
        run: |
          REM Use Visual Studio 2022 Enterprise
          set "VS2022_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
          call "%VS2022_PATH%\VC\Auxiliary\Build\vcvarsall.bat" %vc_arch%

          echo ============== Build Configuration ==============
          echo Architecture: %vc_arch%
          echo OpenSSL: %OPENSSL_ROOT_DIR%
          echo App Version: %APP_VERSION%
          echo ================================================

          mkdir build && cd build

          echo ------------CMake Configuration------------
          cmake -G "%cmake_gen%" -A %vc_arch% ^
            -D CMAKE_BUILD_TYPE=%BUILD_TYPE% ^
            -D CMAKE_PREFIX_PATH="%Qt5_DIR%" ^
            -D QT_VERSION=%QT_VERSION% ^
            -D APP_VERSION=%APP_VERSION% ^
            -D ENABLE_WIX=ON ^
            "%GITHUB_WORKSPACE%\source"
          if ERRORLEVEL 1 exit /b 1

          echo ------------Build Project------------
          cmake --build . --config %BUILD_TYPE%
          if ERRORLEVEL 1 exit /b 1

          echo ------------Copy Dependencies------------
          if exist output\%BUILD_TYPE% (
              if "%vc_arch%"=="x64" (
                  copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x64.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x64.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x64.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x64.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
              ) else (
                  copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x86.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x86.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x86.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
                  copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x86.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
              )
          )

          echo ------------Build Packages (Inno + WiX)------------
          cmake --build . --config %BUILD_TYPE% --target package
          if ERRORLEVEL 1 echo Warning: Package build failed, continuing...

      - name: Make Installer Archives
        run: |
          # Archive all installers
          if exist "build/_CPack_Packages" (
            New-Item -ItemType Directory -Force -Path build/installers
            Get-ChildItem -Path build/_CPack_Packages -Recurse -Filter *.msi | ForEach-Object {
              $dest = "build/installers/$($_.Name)"
              Move-Item $_.FullName -Destination $dest -Force
            }
            Compress-Archive -Path build/installers/* -DestinationPath build/installers-${{ matrix.msvc_arch }}.zip
          }
          if exist "build/_CPack_Packages" (
            Get-ChildItem -Path build/_CPack_Packages -Recurse -Filter *.7z | ForEach-Object {
              Copy-Item $_.FullName -Destination build/
            }
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers-${{ matrix.msvc_arch }}
          path: |
            build/*.zip
            build/*.7z
          retention-days: 30

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: build/*.zip
          generate_release_notes: true
          draft: true
